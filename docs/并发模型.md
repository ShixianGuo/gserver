# 并发模型

并发模型主要有多进程模型、多线程模型和事件驱动模型（select, poll, epoll）。  多进程模型首先进程比较占资源，切换起来也比较麻烦，况且Linux下最大进程数也有限制，所以不考虑。多线程模型同样有最大线程数限制（主要是单独进程虚地址空间有限），大并发下也不适合。  

因为进程创建有一定的开销，所以为了减少创建进程、线程的开销，在并发服务器中也常设置进程池和线程池，这样在有新连接到来时就不需要重新创建造成不必要的开销。除此之外，使用epoll，可以将任务拆分成了独立事件，各个事件可以独立被监视和执行。

* epoll (kernel 2.6+)

* non-blocking I/O

* threadpool  

Linux内核2.6之后开始支持epoll，也是本服务器的核心。epoll模型中内核相当于监控代理，监控的粒度为每一个事件，我们把每个完整的处理过程分拆成了多个独立的事件并在epoll中注册，之后监控是否有事件发生的任务就交给内核来做，一旦监测到事件就分发到相应处理模块。  

本服务器的核心架构： 同步事件循环 + 非阻塞I/O + 线程池，即Reactor模型。

* 多路复用器：由操作系统提供，在 linux 上一般是 select, poll, epoll 等系统调用。   
* 事件分发器：将多路复用器中返回的就绪事件分到对应的处理函数中。  
* 事件处理器：负责处理特定事件的处理函数。 

![](https://gitee.com/shixianguo/blogimage/raw/master/img/20200330124059.png)

Reactor 模式是编写高性能网络服务器的必备技术之一，它具有如下的优点  
* 响应快，不必为单个同步时间所阻塞，虽然 Reactor 本身依然是同步的；  
* 编程相对简单，可以最大程度的避免复杂的多线程及同步问题，并且避免了多线程/进 程的切换开销；  
* 可扩展性，可以方便的通过增加 Reactor 实例个数来充分利用 CPU 资源；   
* 可复用性，reactor 框架本身与具体事件处理逻辑无关，具有很高的复用性； 